package main

import (
	"bytes"
	"database/sql"
	"encoding/json"
	"net/http"
	"net/http/httptest"
	"testing"

	_ "modernc.org/sqlite"
)

func setupCAPATestDB(t *testing.T) *sql.DB {
	testDB, err := sql.Open("sqlite", ":memory:")
	if err != nil {
		t.Fatalf("Failed to open test DB: %v", err)
	}

	if _, err := testDB.Exec("PRAGMA foreign_keys = ON"); err != nil {
		t.Fatalf("Failed to enable foreign keys: %v", err)
	}

	// Create capas table
	_, err = testDB.Exec(`
		CREATE TABLE capas (
			id TEXT PRIMARY KEY,
			title TEXT NOT NULL,
			type TEXT DEFAULT 'corrective' CHECK(type IN ('corrective','preventive')),
			linked_ncr_id TEXT,
			linked_rma_id TEXT,
			root_cause TEXT,
			action_plan TEXT,
			owner TEXT,
			due_date TEXT,
			status TEXT DEFAULT 'open' CHECK(status IN ('open','in_progress','pending_review','closed','cancelled')),
			effectiveness_check TEXT,
			approved_by_qe TEXT,
			approved_by_qe_at DATETIME,
			approved_by_mgr TEXT,
			approved_by_mgr_at DATETIME,
			created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
			updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
		)
	`)
	if err != nil {
		t.Fatalf("Failed to create capas table: %v", err)
	}

	// Create audit_log table
	_, err = testDB.Exec(`
		CREATE TABLE audit_log (
			id INTEGER PRIMARY KEY AUTOINCREMENT,
			user_id INTEGER,
			username TEXT DEFAULT 'system',
			action TEXT NOT NULL,
			module TEXT NOT NULL,
			record_id TEXT NOT NULL,
			summary TEXT,
			created_at DATETIME DEFAULT CURRENT_TIMESTAMP
		)
	`)
	if err != nil {
		t.Fatalf("Failed to create audit_log table: %v", err)
	}

	// Create part_changes table
	_, err = testDB.Exec(`
		CREATE TABLE part_changes (
			id INTEGER PRIMARY KEY AUTOINCREMENT,
			user TEXT,
			table_name TEXT,
			record_id TEXT,
			operation TEXT,
			old_snapshot TEXT,
			new_snapshot TEXT,
			timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
		)
	`)
	if err != nil {
		t.Fatalf("Failed to create part_changes table: %v", err)
	}

	// Create users table for RBAC
	_, err = testDB.Exec(`
		CREATE TABLE users (
			id INTEGER PRIMARY KEY AUTOINCREMENT,
			username TEXT UNIQUE NOT NULL,
			role TEXT DEFAULT 'user' CHECK(role IN ('user','qe','manager','admin')),
			email TEXT,
			password_hash TEXT
		)
	`)
	if err != nil {
		t.Fatalf("Failed to create users table: %v", err)
	}

	// Create sessions table for auth
	_, err = testDB.Exec(`
		CREATE TABLE sessions (
			id INTEGER PRIMARY KEY AUTOINCREMENT,
			user_id INTEGER NOT NULL,
			token TEXT UNIQUE NOT NULL,
			created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
			expires_at DATETIME,
			FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
		)
	`)
	if err != nil {
		t.Fatalf("Failed to create sessions table: %v", err)
	}

	// Create email_subscriptions table for notifications
	_, err = testDB.Exec(`
		CREATE TABLE email_subscriptions (
			id INTEGER PRIMARY KEY AUTOINCREMENT,
			email TEXT NOT NULL,
			event_type TEXT NOT NULL
		)
	`)
	if err != nil {
		t.Fatalf("Failed to create email_subscriptions table: %v", err)
	}

	return testDB
}

func insertTestCAPA(t *testing.T, db *sql.DB, id, title, capaType, status, owner, dueDate string) {
	_, err := db.Exec(
		"INSERT INTO capas (id, title, type, status, owner, due_date, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, datetime('now'), datetime('now'))",
		id, title, capaType, status, owner, dueDate,
	)
	if err != nil {
		t.Fatalf("Failed to insert test CAPA: %v", err)
	}
}

func insertTestUser(t *testing.T, db *sql.DB, id int, username, role string) {
	_, err := db.Exec(
		"INSERT INTO users (id, username, role, password_hash) VALUES (?, ?, ?, 'hash')",
		id, username, role,
	)
	if err != nil {
		t.Fatalf("Failed to insert test user: %v", err)
	}
}

func insertTestSession(t *testing.T, db *sql.DB, userID int, token string) {
	_, err := db.Exec(
		"INSERT INTO sessions (user_id, token, created_at) VALUES (?, ?, datetime('now'))",
		userID, token,
	)
	if err != nil {
		t.Fatalf("Failed to insert test session: %v", err)
	}
}

// Test List CAPAs - Empty
func TestHandleListCAPAs_Empty(t *testing.T) {
	oldDB := db
	db = setupCAPATestDB(t)
	defer func() { db.Close(); db = oldDB }()

	req := httptest.NewRequest("GET", "/api/capas", nil)
	w := httptest.NewRecorder()

	handleListCAPAs(w, req)

	if w.Code != 200 {
		t.Errorf("Expected status 200, got %d", w.Code)
	}

	var resp APIResponse
	if err := json.NewDecoder(w.Body).Decode(&resp); err != nil {
		t.Fatalf("Failed to decode response: %v", err)
	}

	capas, ok := resp.Data.([]interface{})
	if !ok {
		t.Fatalf("Expected data to be an array")
	}

	if len(capas) != 0 {
		t.Errorf("Expected empty array, got %d CAPAs", len(capas))
	}
}

// Test Create CAPA - Valid
func TestHandleCreateCAPA_Valid(t *testing.T) {
	oldDB := db
	db = setupCAPATestDB(t)
	defer func() { db.Close(); db = oldDB }()

	capa := CAPA{
		Title:      "Fix quality issue",
		Type:       "corrective",
		RootCause:  "Incorrect assembly procedure",
		ActionPlan: "Update work instructions",
		Owner:      "eng1",
		DueDate:    "2026-03-31",
	}

	body, _ := json.Marshal(capa)
	req := httptest.NewRequest("POST", "/api/capas", bytes.NewReader(body))
	w := httptest.NewRecorder()

	handleCreateCAPA(w, req)

	if w.Code != 200 {
		t.Errorf("Expected status 200, got %d: %s", w.Code, w.Body.String())
	}
}

// Test Update CAPA - QE Approval
func TestHandleUpdateCAPA_QEApproval(t *testing.T) {
	oldDB := db
	db = setupCAPATestDB(t)
	defer func() { db.Close(); db = oldDB }()

	// Create QE user and session
	insertTestUser(t, db, 1, "qeuser", "qe")
	insertTestSession(t, db, 1, "qe-token")

	insertTestCAPA(t, db, "CAPA-001", "Test CAPA", "corrective", "open", "eng1", "2026-03-31")

	updateData := map[string]interface{}{
		"approved_by_qe": "1",
	}

	body, _ := json.Marshal(updateData)
	req := httptest.NewRequest("PUT", "/api/capas/CAPA-001", bytes.NewReader(body))
	req.AddCookie(&http.Cookie{Name: "zrp_session", Value: "qe-token"})
	w := httptest.NewRecorder()

	handleUpdateCAPA(w, req, "CAPA-001")

	if w.Code != 200 {
		t.Errorf("Expected status 200, got %d: %s", w.Code, w.Body.String())
	}

	// Verify approval was recorded
	var approvedByQE string
	var approvedAt sql.NullString
	db.QueryRow("SELECT approved_by_qe, approved_by_qe_at FROM capas WHERE id = ?", "CAPA-001").Scan(&approvedByQE, &approvedAt)
	if approvedByQE != "1" {
		t.Errorf("Expected approved_by_qe to be '1', got %s", approvedByQE)
	}
	if !approvedAt.Valid {
		t.Error("Expected approved_by_qe_at to be set")
	}
}

// Test Update CAPA - Cannot Close Without Approvals
func TestHandleUpdateCAPA_CloseWithoutApprovals(t *testing.T) {
	oldDB := db
	db = setupCAPATestDB(t)
	defer func() { db.Close(); db = oldDB }()

	insertTestUser(t, db, 1, "testuser", "user")
	insertTestSession(t, db, 1, "test-token")

	insertTestCAPA(t, db, "CAPA-001", "Test CAPA", "corrective", "in_progress", "eng1", "2026-03-31")
	db.Exec("UPDATE capas SET effectiveness_check = ? WHERE id = ?", "Verified effective", "CAPA-001")

	updateData := map[string]interface{}{
		"status": "closed",
	}

	body, _ := json.Marshal(updateData)
	req := httptest.NewRequest("PUT", "/api/capas/CAPA-001", bytes.NewReader(body))
	req.AddCookie(&http.Cookie{Name: "zrp_session", Value: "test-token"})
	w := httptest.NewRecorder()

	handleUpdateCAPA(w, req, "CAPA-001")

	if w.Code != 400 {
		t.Errorf("Expected status 400, got %d", w.Code)
	}

	if !bytes.Contains(w.Body.Bytes(), []byte("approval required")) {
		t.Error("Expected error about missing approvals")
	}
}
